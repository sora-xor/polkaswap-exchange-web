var st=Object.defineProperty;var it=(r,t,e)=>t in r?st(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var o=(r,t,e)=>it(r,typeof t!="symbol"?t+"":t,e);import{ab as Y,ac as j,f as E,b7 as x,m as rt,$ as k,gB as v,gA as R,b as p,gN as at,c as M,gO as nt,aH as U,aI as ot,b8 as ct,g as G,h as Q,W as ht,C as lt,_ as N,l as w,j as C,aJ as pt,P as T,n as ut}from"./index-BHqySXo4.js";import"./index-xje9WUu-.js";import{p as $}from"./pick-Bpm14bMh.js";import{C as mt}from"./ChartSpecMixin-GBpLmNyN.js";import{S as z}from"./icons-BcLzFrMT.js";import{T as A,S as dt}from"./snapshots-CDsBWfuS.js";const{IndexerType:O}=E,ft=r=>{const{open:t,close:e,low:s,high:i}=r.priceUSD;return[+t,+e,+s,+i]},gt=r=>{const t=+r.timestamp*1e3,e=ft(r),s=+r.volume.amountUSD;return{timestamp:t,price:e,volume:s}},yt=(r,t)=>({assetId:{equalTo:r},type:{equalTo:t}}),bt=Y`
  query SubqueryAssetPriceQuery($after: Cursor = "", $filter: AssetSnapshotFilter, $first: Int = null) {
    data: assetSnapshots(after: $after, first: $first, filter: $filter, orderBy: [TIMESTAMP_DESC]) {
      pageInfo {
        hasNextPage
        endCursor
      }
      edges {
        node {
          priceUSD
          timestamp
          volume
        }
      }
    }
  }
`,St=(r,t)=>({asset:{id_eq:r},type_eq:t}),Pt=Y`
  query SubsquidAssetPriceQuery($after: String = null, $filter: AssetSnapshotWhereInput, $first: Int = 1000) {
    data: assetSnapshotsConnection(after: $after, first: $first, where: $filter, orderBy: [timestamp_DESC]) {
      pageInfo {
        hasNextPage
        endCursor
      }
      edges {
        node {
          priceUSD {
            close
            high
            low
            open
          }
          volume {
            amountUSD
          }
          timestamp
        }
      }
    }
  }
`;async function xt(r,t,e,s){const i=j();let a;switch(i.type){case O.SUBQUERY:{const n=i,h={filter:yt(r,t),first:e,after:s};a=await n.services.explorer.fetchEntities(bt,h);break}case O.SUBSQUID:{const n=i;s===""&&(s=null);const h={filter:St(r,t),first:e,after:s};a=await n.services.explorer.fetchEntitiesConnection(Pt,h);break}}return a?{...a,edges:a.edges.map(n=>({...n,node:gt(n.node)}))}:null}var At=Object.defineProperty,It=Object.getOwnPropertyDescriptor,y=(r,t,e,s)=>{for(var i=s>1?void 0:s?It(t,e):t,a=r.length-1,n;a>=0;a--)(n=r[a])&&(i=(s?n(t,e,i):n(i))||i);return s&&i&&At(t,e,i),i};const wt="USD",Ct={line:z.LineIcon,candlestick:z.CandleIcon},B=[{name:A.FIVE_MINUTES,label:"5m",type:x.SnapshotTypes.DEFAULT,count:48},{name:A.FIFTEEN_MINUTES,label:"15m",type:x.SnapshotTypes.DEFAULT,count:48*3,group:3},{name:A.THIRTY_MINUTES,label:"30m",type:x.SnapshotTypes.DEFAULT,count:48*6,group:6},{name:A.HOUR,label:"1H",type:x.SnapshotTypes.HOUR,count:48},{name:A.FOUR_HOURS,label:"4H",type:x.SnapshotTypes.HOUR,count:48*4,group:4},{name:A.DAY,label:"1D",type:x.SnapshotTypes.DAY,count:90},{name:A.YEAR,label:"1Y",type:x.SnapshotTypes.DAY,count:365},{name:A.ALL,label:"ALL",type:x.SnapshotTypes.DAY,count:1/0}],Tt=4,Ft=8,H={fontFamily:"Sora",fontSize:10,fontWeight:300,lineHeigth:1.5},V=6*1e3,Z="chartZoom",vt=r=>{const t=setInterval(r,V*5);return()=>clearInterval(t)},X=r=>(t,e,s)=>p.FPNumber.gt(r,p.FPNumber.ZERO)?t:p.FPNumber.lt(r,p.FPNumber.ZERO)?e:s,Ut=r=>{const t=X(r)("+","",""),e=pt(r,!0);return`${t}${e}`},K=(r,t)=>r.toLocaleString(t),Dt=(r,t,e)=>`${K(r,t)} ${e}`,_t=(r,t)=>t!==0?r/t:0,Lt=(r,t)=>r.map((e,s)=>_t(e,t[s])),W=(r,t)=>{const e=(r==null?void 0:r.timestamp)??(t==null?void 0:t.timestamp),s=t!=null&&t.price&&(r!=null&&r.price)?Lt(r.price,t.price):(r==null?void 0:r.price)??[0,0,0,0],i=t!=null&&t.volume&&(r!=null&&r.volume)?Math.min(t.volume,r.volume):(r==null?void 0:r.volume)??0;return{timestamp:e,price:s,volume:i}},kt=(r,t,e)=>{var i;const s=[];for(const a of r){const n=[],c=((i=U(s))==null?void 0:i.timestamp)??e;let h=a.timestamp;for(;(h+=t)<c;)n.push({timestamp:h,price:[a.price[1],a.price[1],a.price[1],a.price[1]],volume:0});s.push(...n.reverse(),a)}return s},Et=r=>{let t=2;if(r===0||!Number.isFinite(r))return t;let e=Math.abs(r);for(;Math.floor(e)<=0;)e=e*10,t++;return t};let f=class extends rt(mt,k.LoadingMixin,k.NumberFormatterMixin,k.FormattedAmountMixin){constructor(){super(...arguments);o(this,"currency");o(this,"currencies");o(this,"exchangeRate");o(this,"currencySymbol");o(this,"baseAsset");o(this,"quoteAsset");o(this,"requestEntityId");o(this,"requestMethod");o(this,"requestSubscription");o(this,"isAvailable");o(this,"isFetchingError",!1);o(this,"FontWeightRate",E.FontWeightRate);o(this,"snapshotBuffer",{});o(this,"pageInfos",{});o(this,"dataset",[]);o(this,"zoomStart",0);o(this,"zoomEnd",100);o(this,"precision",2);o(this,"limits",{min:1/0,max:0});o(this,"updatePrices",R(this.getHistoricalPrices,250,{leading:!1}));o(this,"forceUpdatePrices",R(this.resetAndUpdatePrices,250,{leading:!1}));o(this,"priceUpdateRequestId",0);o(this,"priceUpdateSubscription",null);o(this,"priceUpdateTimestampSync",null);o(this,"chartType","line");o(this,"selectedFilter",B[0]);o(this,"isReversedChart",!1)}handleTokensChange(t,e){if(!v(t)(e)){const s=this.isReversedChart?[...e].reverse():e;this.isReversedChart=!1,v(t)(s)||this.forceUpdatePrices()}}toAmount(t,e){const s=t instanceof p.FPNumber?t:new p.FPNumber(t),i=this.isTokensPair?s:s.mul(this.exchangeRate);return K(i,e)}toPrice(t,e){const s=t instanceof p.FPNumber?t:new p.FPNumber(t),i=this.isTokensPair?s:s.mul(this.exchangeRate);return Dt(i,e,this.symbol)}get chartKey(){if(!this.isTokensPair)return`price-chart-${this.symbol}-rate-${this.exchangeRate}`}get isLineChart(){return this.chartType==="line"}get inputTokensAddresses(){return[this.baseAsset,this.quoteAsset].filter(e=>!!e).map(e=>e.address)}get tokenA(){return this.isReversedChart?this.quoteAsset:this.baseAsset}get tokenB(){return this.isReversedChart?this.baseAsset:this.quoteAsset}get tokens(){return[this.tokenA,this.tokenB].filter(t=>!!t)}get tokensAddresses(){return this.tokens.map(t=>t.address)}get isTokensPair(){return this.tokensAddresses.length===2}get reversible(){return this.isTokensPair&&!this.requestEntityId}get entities(){return this.requestEntityId?[this.requestEntityId]:this.tokensAddresses}get chartTypeButtons(){return["line","candlestick"].map(t=>({type:t,icon:Ct[t],active:this.chartType===t}))}get filters(){return B}get chartIsLoading(){return this.parentLoading||this.loading}get symbol(){var t,e;return((t=this.tokenB)==null?void 0:t.symbol)??(((e=at(this.currency,this.currencies))==null?void 0:e.key.toUpperCase())||wt)}get currentPrice(){var t;return new p.FPNumber(((t=this.dataset[0])==null?void 0:t.price[1])??0)}get currentPriceFormatted(){return this.toAmount(this.currentPrice,this.precision)}get isAllHistoricalPricesFetched(){return Object.entries(this.pageInfos).some(([t,e])=>{var i;const s=((i=this.snapshotBuffer[t])==null?void 0:i.length)===this.dataset.length;return!e.hasNextPage&&s})}get timeDifference(){return dt[this.selectedFilter.type]*1e3}get visibleChartItemsRange(){const t=this.chartData.length,e=Math.floor(t*this.zoomStart/100),s=Math.ceil(t*this.zoomEnd/100)-1;return[e,s]}get priceChange(){var a,n;const[t,e]=this.visibleChartItemsRange,s=new p.FPNumber(((a=this.chartData[t])==null?void 0:a[2])??0),i=new p.FPNumber(((n=this.chartData[e])==null?void 0:n[2])??0);return M(i,s)}get gridLeftOffset(){const t=this.limits.max*10,e=nt(new p.FPNumber(t).toLocaleString(this.precision),H.fontFamily,H.fontSize);return Ft+2*Tt+e}get chartData(){const t=[],{dataset:e,selectedFilter:{group:s}}=this,i=e.slice().reverse();for(let a=0;a<i.length;a++)if(!s||a%s===0)t.push([i[a].timestamp,...i[a].price,i[a].volume]);else{const n=U(t);n&&(n[2]=i[a].price[1],n[3]=Math.min(n[3],i[a].price[2]),n[4]=Math.max(n[4],i[a].price[3]),n[5]=n[5]+(i[a].volume??0))}return Object.freeze(t)}get chartSpec(){const t=this.entities.length===1,e=this.gridSpec({top:20,left:this.gridLeftOffset}),s=this.gridSpec({height:72,left:this.gridLeftOffset}),i=this.xAxisSpec({boundaryGap:this.isLineChart?!1:[.005,.005],axisLabel:{show:!0},axisLine:{show:!0,lineStyle:{color:this.theme.color.base.content.tertiary}},axisPointer:{label:{show:!0}}}),a=this.xAxisSpec({gridIndex:1,boundaryGap:!1,axisLabel:{show:!0},axisPointer:{type:"none"}}),n=this.yAxisSpec({axisLabel:{formatter:d=>this.toAmount(d,this.precision),showMaxLabel:!1,showMinLabel:!1},axisPointer:{label:{precision:this.precision,formatter:({value:d})=>this.toAmount(d,this.precision)}},min:"dataMin",max:"dataMax"}),c=this.yAxisSpec({gridIndex:1,splitNumber:2,axisLabel:{formatter:d=>{const S=new p.FPNumber(d).mul(this.exchangeRate),{amount:b,suffix:g}=ot(S);return`${b} ${g}`},showMaxLabel:!0}}),h={id:Z,type:"inside",xAxisIndex:[0,1],start:0,end:100,minValueSpan:this.timeDifference*11},l=this.tooltipSpec({axisPointer:{type:"cross"},formatter:d=>{const{data:S,seriesType:b}=d[0],[,g,D,_,J,tt]=S,F=[],L=new p.FPNumber(D);if(b==="candlestick"){const I=new p.FPNumber(g),q=M(L,I),et=X(q)(this.theme.color.status.success,this.theme.color.status.error,this.theme.color.base.content.primary);F.push({title:"Open",data:this.toPrice(I,this.precision)},{title:"High",data:this.toPrice(J,this.precision)},{title:"Low",data:this.toPrice(_,this.precision)},{title:"Close",data:this.toPrice(L,this.precision)},{title:"Change",data:Ut(q),color:et})}else F.push({title:"Price",data:this.toPrice(L,this.precision)});return t&&F.push({title:"Volume",data:`${this.currencySymbol} ${this.toAmount(tt,2)}`}),`
          <table>
            ${F.map(I=>`
              <tr>
                <td align="right" style="color:${this.theme.color.base.content.secondary}">${I.title}</td>
                <td style="color:${I.color??this.theme.color.base.content.primary}">${I.data}</td>
              </tr>
            `).join("")}
          </table>
        `}}),u=this.isLineChart?this.lineSeriesSpec({encode:{y:"close"},areaStyle:{opacity:.8,color:new ct(0,0,0,1,[{offset:0,color:"rgba(248, 8, 123, 0.25)"},{offset:1,color:"rgba(255, 49, 148, 0.03)"}])}}):this.candlestickSeriesSpec(),P={type:"bar",barMaxWidth:10,xAxisIndex:1,yAxisIndex:1,itemStyle:{color:({data:d})=>{const[S,b,g]=d;return b>g?this.theme.color.status.error:b<g?this.theme.color.status.success:this.theme.color.base.content.secondary},opacity:.7},encode:{y:"volume"}},m={animation:!1,axisPointer:{link:[{xAxisIndex:"all"}]},color:[this.theme.color.theme.accent,this.theme.color.status.success],dataset:{source:this.chartData,dimensions:["timestamp","open","close","low","high","volume"]},dataZoom:[h],grid:[e],xAxis:[i],yAxis:[n],tooltip:l,series:[u]};return t&&(e.bottom=120,i.axisLabel.show=!1,i.axisPointer.label.show=!1,m.grid.push(s),m.xAxis.push(a),m.yAxis.push(c),m.series.push(P)),m}created(){this.forceUpdatePrices()}beforeDestroy(){this.unsubscribeFromPriceUpdates()}async requestData(t,e,s,i=!0,a){const n=[];do{const c=j().type===E.IndexerType.SUBSQUID?1e3:100,h=Math.min(s,c),l=await this.requestMethod(t,e,h,a);if(!l)throw new Error("Chart data fetch error");i=l.pageInfo.hasNextPage,a=l.pageInfo.endCursor,n.push(...l.edges.map(u=>u.node)),s-=l.edges.length}while(i&&s>0);return{nodes:n,hasNextPage:i,endCursor:a}}async fetchData(t){var S,b;const{type:e,count:s}=this.selectedFilter,i=this.pageInfos[t],a=(i==null?void 0:i.hasNextPage)??!0,n=(i==null?void 0:i.endCursor)??void 0,c=this.snapshotBuffer[t]??[],h=this.dataset.length,l=c.slice(h);if(l.length>=s||!a)return l;const{nodes:u,...P}=await this.requestData(t,e,s,a,n),m=((S=U(l))==null?void 0:S.timestamp)??((b=U(this.dataset))==null?void 0:b.timestamp)??Date.now(),d=kt(u,this.timeDifference,m);return this.fillSnapshotBuffer(t,d),this.pageInfos[t]=P,[...l,...d]}async fetchDataLastUpdates(t){const e={};return await Promise.all(t.map(async s=>{try{const a=(await this.requestData(s,this.selectedFilter.type,1)).nodes[0];e[s]=a}catch{return null}})),e}getUpdatedPrecision(t,e){const s=[e,t,e-t].map(i=>Et(i));return Math.max(...s)}async getHistoricalPrices(){if(this.loading||this.isAllHistoricalPricesFetched)return;const t=[...this.entities],e=Date.now();this.priceUpdateRequestId=e,await this.withApi(async()=>{var s,i,a,n;try{const c=await Promise.all(t.map(m=>this.fetchData(m)));if(!(this.requestIsAllowed(t)&&v(e)(this.priceUpdateRequestId)))return;const h=[],l=Math.min(((s=c[0])==null?void 0:s.length)??1/0,((i=c[1])==null?void 0:i.length)??1/0,this.selectedFilter.count);let{min:u,max:P}=this.limits;for(let m=0;m<l;m++){const d=(a=c[0])==null?void 0:a[m],S=(n=c[1])==null?void 0:n[m],{timestamp:b,price:g,volume:D}=W(d,S);if(!g.some(_=>!Number.isFinite(_))){if(g[0]===0&&g[1]===0)break;h.push({timestamp:b,price:g,volume:D}),u=Math.min(u,...g),P=Math.max(P,...g)}}this.limits={min:u,max:P},this.precision=this.getUpdatedPrecision(u,P),this.updateDataset([...this.dataset,...h]),this.isFetchingError=!1}catch(c){this.isFetchingError=!0,console.error(c)}})}fillSnapshotBuffer(t,e){const s=this.snapshotBuffer[t]??[];this.snapshotBuffer[t]=Object.freeze([...s,...e])}async subscribeToPriceUpdates(){if(this.unsubscribeFromPriceUpdates(),!this.entities.length)return;const t=[...this.entities];this.priceUpdateSubscription=await this.getPriceUpdatesSubscription(t),this.priceUpdateTimestampSync=setInterval(()=>this.handlePriceTimestampSync(t),V)}unsubscribeFromPriceUpdates(){this.priceUpdateSubscription&&this.priceUpdateSubscription(),this.priceUpdateTimestampSync&&clearInterval(this.priceUpdateTimestampSync),this.priceUpdateSubscription=null,this.priceUpdateTimestampSync=null}async getPriceUpdatesSubscription(t){const e=()=>this.fetchAndHandleUpdate(t);return await this.requestSubscription(e)}getCurrentSnapshotTimestamp(){const t=Math.floor(Date.now()/1e3),e=this.timeDifference/1e3,s=Math.floor(t/e);return e*s*1e3}handlePriceTimestampSync(t){if(!this.requestIsAllowed(t))return;const e=this.getCurrentSnapshotTimestamp(),s=this.dataset[0];if(!s||e===s.timestamp)return;const i=s.price[1],c={timestamp:e,price:[i,i,i,i],volume:0};this.updateDataset([c,...this.dataset])}async fetchAndHandleUpdate(t){if(!this.requestIsAllowed(t))return;const e=await this.fetchDataLastUpdates(t);if(!e)return;const s=[...this.dataset],i=s[0],[a,n]=t.map(u=>e[u]),c=W(a,n);if(c.price.some(u=>!Number.isFinite(u))||(i==null?void 0:i.timestamp)>c.timestamp)return;(i==null?void 0:i.timestamp)===c.timestamp&&s.shift(),s.unshift(c);const h=Math.min(this.limits.min,...c.price),l=Math.max(this.limits.max,...c.price);this.precision=this.getUpdatedPrecision(h,l),this.limits={min:h,max:l},this.updateDataset(s)}requestIsAllowed(t){return this.isTokensPair&&!this.isAvailable?!1:v(t)(this.entities)}clearData(t=!1,e=!1){this.snapshotBuffer=e?{}:$(this.entities,this.snapshotBuffer),this.pageInfos=e?{}:$(this.entities,this.pageInfos),this.dataset=[],this.zoomStart=0,this.zoomEnd=100,this.limits={min:1/0,max:0},this.precision=2,t||(this.isReversedChart=!1)}updateDataset(t){this.dataset=Object.freeze(t)}async changeFilter(t){const e=this.selectedFilter.type,{count:s,type:i}=t;this.selectedFilter=t,e!==i?await this.forceUpdatePrices(!0,!0):this.dataset.length<s?await this.updatePrices():await this.resetChartTypeZoom()}async resetChartTypeZoom(){const{count:t,group:e}=this.selectedFilter,s=this.chartData.length,i=t/(e??1),a=s>i?(s-i)*100/s:0;await this.setChartZoomLevel(a,100)}async resetAndUpdatePrices(t=!1,e=!1){this.clearData(t,e),await this.updatePrices(),await this.subscribeToPriceUpdates()}async selectChartType(t){this.chartType=t,await this.setChartZoomLevel(this.zoomStart,this.zoomEnd)}handleZoom(t){var e;(e=t==null?void 0:t.stop)==null||e.call(t),(t==null?void 0:t.wheelDelta)<0&&this.zoomStart===0&&this.zoomEnd===100&&this.updatePrices()}changeZoomLevel(t){var s;const e=(s=t==null?void 0:t.batch)==null?void 0:s[0];this.zoomStart=(e==null?void 0:e.start)??0,this.zoomEnd=(e==null?void 0:e.end)??0}async setChartZoomLevel(t,e){await this.$nextTick(),this.$refs.chart.dispatchAction({type:"dataZoom",batch:[{dataZoomId:Z,start:t,end:e}]})}revertChart(){this.isReversedChart=!this.isReversedChart,this.forceUpdatePrices(!0,!1)}};y([G.wallet.settings.currency],f.prototype,"currency",2);y([G.wallet.settings.currencies],f.prototype,"currencies",2);y([Q.wallet.settings.exchangeRate],f.prototype,"exchangeRate",2);y([Q.wallet.settings.currencySymbol],f.prototype,"currencySymbol",2);y([T({default:()=>null,type:Object})],f.prototype,"baseAsset",2);y([T({default:()=>null,type:Object})],f.prototype,"quoteAsset",2);y([T({default:()=>null,type:String})],f.prototype,"requestEntityId",2);y([T({default:xt,type:Function})],f.prototype,"requestMethod",2);y([T({default:vt,type:Function})],f.prototype,"requestSubscription",2);y([T({default:!1,type:Boolean})],f.prototype,"isAvailable",2);y([ht("inputTokensAddresses")],f.prototype,"handleTokensChange",1);f=y([lt({components:{TokenLogo:N.TokenLogo,FormattedAmount:N.FormattedAmount,BaseWidget:w(C.BaseWidget),SvgIconButton:w(C.SvgIconButton),TokensRow:w(C.TokensRow),PriceChange:w(C.PriceChange),StatsFilter:w(C.StatsFilter),ChartSkeleton:w(C.ChartSkeleton)}})],f);var qt=function(){var t=this,e=t._self._c;return t._self._setupProxy,e("base-widget",t._b({scopedSlots:t._u([{key:"title",fn:function(){return[t._t("title",function(){return[e("tokens-row",{attrs:{border:"",assets:t.tokens,size:"medium"}}),t.tokenA?e("div",{staticClass:"token-title"},[e("span",[t._v(t._s(t.tokenA.symbol))]),t.tokenB?e("span",[t._v("/"+t._s(t.tokenB.symbol))]):t._e()]):t._e(),t.reversible?e("s-button",{class:{"s-pressed":t.isReversedChart},attrs:{disabled:t.chartIsLoading,size:"small",type:"action",alternative:"",icon:"arrows-swap-90-24"},on:{click:t.revertChart}}):t._e()]})]},proxy:!0},{key:"filters",fn:function(){return[e("stats-filter",{attrs:{"is-dropdown":"",filters:t.filters,value:t.selectedFilter,disabled:t.chartIsLoading},on:{input:t.changeFilter}}),t._l(t.chartTypeButtons,function({type:s,icon:i,active:a}){return e("svg-icon-button",{key:s,attrs:{icon:i,active:a,disabled:t.chartIsLoading,size:"small"},on:{click:function(n){return t.selectChartType(s)}}})})]},proxy:!0},{key:"types",fn:function(){return[t._t("types")]},proxy:!0}],null,!0)},"base-widget",t.$attrs,!1),[e("chart-skeleton",{attrs:{loading:t.chartIsLoading,"is-empty":t.chartData.length===0,"is-error":t.isFetchingError},on:{retry:t.updatePrices}},[e("formatted-amount",{staticClass:"charts-price",attrs:{value:t.currentPriceFormatted,"font-weight-rate":t.FontWeightRate.MEDIUM,"font-size-rate":t.FontWeightRate.MEDIUM,"asset-symbol":t.symbol,"symbol-as-decimal":""}}),t.isFetchingError?t._e():e("price-change",{attrs:{value:t.priceChange}}),e("v-chart",{key:t.chartKey,ref:"chart",staticClass:"chart",attrs:{option:t.chartSpec,autoresize:""},on:{"zr:mousewheel":t.handleZoom,datazoom:t.changeZoomLevel}})],1)],1)},Rt=[],Mt=ut(f,qt,Rt,!1,null,null);const Wt=Mt.exports;export{Wt as default};
